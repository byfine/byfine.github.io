---
layout: post
title: OpenGL 面剔除（Face culling）
description: "OpenGL 面剔除 简介"
modified: 2015-10-23
tags: [OpenGL]
---

##Face culling：
对于一个3D立方体，从任何一个方向去看它，你会发现最多能同时看到的面是3个。所以我们为何还要去绘制那三个不会显示出来的面呢。如果我们可以以某种方式丢弃它们，我们会提高片段着色器超过50%的性能！
我们说的是超过50%而不是50%，是因为有时从一个角度只有2个或1个面能够被看到。这种情况下我们就能够提高50%以上性能了。

这的确是个好主意，但是有个问题需要解决：我们如何知道某个面在观察者的视野中不会出现呢？如果我们去想象任何封闭的几何平面，它们都有两面，一面面向用户，另一面背对用户。假如我们只渲染面向观察者的面会怎样？

这正是**面剔除**(Face culling)所要做的。OpenGL允许检查所有正面朝向（Front facing）观察者的面，并渲染它们，而丢弃所有背面朝向（Back facing）的面，这样就节约了我们很多片段着色器的命令（它们很昂贵！）。我们必须告诉OpenGL我们使用的哪个面是正面，哪个面是反面。OpenGL使用一种聪明的手段解决这个问题——分析顶点数据的连接顺序（Winding order）。

##顶点连接顺序（Winding order）：
当我们定义一系列的三角顶点时，我们会把它们定义为一个特定的连接顺序，它们可能是顺时针的或逆时针的。每个三角形由3个顶点组成，我们从三角形的中间去看，从而把这三个顶点指定一个连接顺序。

![]({{ site.url }}/images/post/2015-10-23/OpenGL FaceCulling 1.png)

正如你所看到的那样，我们先定义了顶点1，接着我们定义顶点2或3，这个不同的选择决定了这个三角形的连接顺序。下面的代码展示出这点：

    GLfloat vertices[] = {
        //顺时针
        vertices[0], // vertex 1
        vertices[1], // vertex 2
        vertices[2], // vertex 3
        // 逆时针
        vertices[0], // vertex 1
        vertices[2], // vertex 3
        vertices[1] // vertex 2
    };


每三个顶点都形成了一个包含着连接顺序的基本三角形。OpenGL使用这个信息在渲染基本图形的时候决定这个三角形是正面还是背面。默认情况下，逆时针的顶点连接顺序被定义为三角形的正面。

所以如果你要定义一个能够看到的三角形，就应该是逆时针的。实际计算的顶点连接顺序是在光栅化阶段（Rasterization stage）进行的，所以当顶点着色器已经运行后，顶点就能够在观察者的观察点被看到。

我们指定了它们以后，观察者面对的所有的三角形的顶点的连接顺序都是正确的，但是现在渲染的立方体另一面的三角形的顶点的连接顺序被反转。最终，我们所面对的三角形被视为正面朝向的三角形，后部的三角形被视为背面朝向的三角形。下图展示了这个效果：

![]({{ site.url }}/images/post/2015-10-23/OpenGL FaceCulling 2.png)

在顶点数据中，我们定义的是两个逆时针顺序的三角形。然而，从观察者的方面看，后面的三角形是顺时针的，如果我们仍以1、2、3的顺序以观察者当面的视野看的话。即使我们以逆时针顺序定义后面的三角形，它现在还是变为顺时针。它正是我们打算剔除（丢弃）的不可见的面。

##面剔除：
现在我们知道了如何设置顶点的连接顺序，可以开始使用OpenGL默认关闭的面剔除选项了。
我们要重新定义立方体的顶点数据，以使它反应为一个逆时针链接顺序。把所有三角的顶点都定义为逆时针是一个很好的习惯。

开启OpenGL的GL_CULL_FACE选项就能开启面剔除功能：

    glEnable(GL_CULL_FACE);

从这儿以后，所有不是正面朝向的面都会被丢弃。目前，在渲染片段上我们节约了超过50%的性能，但记住这只对像立方体这样的封闭形状有效。当我们绘制如草这样的平板时，我们必须关闭面剔除，这是因为它的前、后面都必须是可见的。

OpenGL允许我们改变剔除面的类型。要是我们剔除正面而不是背面会怎样？我们可以调用glCullFace来做这件事：

    glCullFace(GL_BACK);

glCullFace函数有三个可用的选项：

- GL_BACK：只剔除背面。
- GL_FRONT：只剔除正面。
- GL_FRONT_AND_BACK：剔除背面和正面。

glCullFace的初始值是GL_BACK。另外，我们还可以告诉OpenGL使用顺时针而不是逆时针来表示正面，这通过glFrontFace来设置：

    glFrontFace(GL_CCW);

默认值是GL_CCW，它代表逆时针，GL_CW代表顺时针顺序。

---
> 参考
[LearnOpenGL-CN 面剔除](http://learnopengl-cn.readthedocs.org/zh/latest/04%20Advanced%20OpenGL/04%20Face%20culling/)